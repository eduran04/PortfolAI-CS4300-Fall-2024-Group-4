name: Dependency Review

# CRITICAL SECURITY POLICY:
# ALL dependency vulnerability checks in this workflow are BLOCKING REQUIREMENTS.
# PRs CANNOT be merged if ANY dependency vulnerability check fails.
# This is non-negotiable and must be followed for all branches.
#
# Blocking checks:
#   - Dependency Review Action (GitHub's built-in dependency review)
#   - pip-audit (CVE dependency scan)
#   - Safety (Additional CVE check)

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]
  schedule:
    # Run weekly on Mondays at 9am UTC
    - cron: '0 9 * * 1'

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    name: GitHub Dependency Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Report
        uses: actions/dependency-review-action@v4

  pip-audit:
    name: pip-audit - CVE Dependency Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.3'
          cache: 'pip'

      - name: Install pip-audit
        run: |
          cd portfolai
          pip install --no-cache-dir pip-audit

      - name: Run pip-audit
        # BLOCKING: pip-audit CVE failures will prevent PR merge (required for security compliance)
        run: |
          cd portfolai
          pip-audit -r requirements.txt --desc --format json -o pip-audit-report.json || true
          pip-audit -r requirements.txt --desc | tee pip-audit-screen.txt || true

      - name: Upload pip-audit JSON Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report-json
          path: portfolai/pip-audit-report.json

      - name: Upload pip-audit Screen Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report-txt
          path: portfolai/pip-audit-screen.txt

      - name: Comment pip-audit Results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';
            try {
              report = fs.readFileSync('portfolai/pip-audit-screen.txt', 'utf8');
            } catch (e) {
              report = 'No vulnerabilities found or scan errored (check artifacts)';
            }

            const hasVulns = report.includes('Found') && !report.includes('Found 0');
            const status = hasVulns ? 'Vulnerabilities Found' : 'No CVEs Found';

            const comment = `## pip-audit CVE Scan\n\n**Status: ${status}**\n\n**Checks:** Known CVE vulnerabilities in Python dependencies\n\n<details>\n<summary>Full Report</summary>\n\n\`\`\`\n${report}\n\`\`\`\n\n</details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  safety:
    name: Safety - Additional CVE Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.3'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd portfolai
          python -m pip install --no-cache-dir --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          pip install --no-cache-dir safety

      - name: Run Safety Check
        # BLOCKING: Safety CVE failures will prevent PR merge (required for security compliance)
        run: |
          cd portfolai
          safety check --continue-on-error --save-json safety-report.json || true
          safety check --continue-on-error | tee safety-screen.txt || true

      - name: Upload Safety Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safety-reports
          path: |
            portfolai/safety-report.json
            portfolai/safety-screen.txt

      - name: Comment Safety Results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';
            try {
              report = fs.readFileSync('portfolai/safety-screen.txt', 'utf8');
            } catch (e) {
              report = 'No vulnerabilities found or scan errored (check artifacts)';
            }

            const hasVulns = report.includes('found') && !report.includes('No known security vulnerabilities found');
            const status = hasVulns ? 'Vulnerabilities Found' : 'No CVEs Found';

            const comment = `## Safety CVE Scan\n\n**Status: ${status}**\n\n**Checks:** Known CVE vulnerabilities in Python dependencies\n\n<details>\n<summary>Full Report</summary>\n\n\`\`\`\n${report}\n\`\`\`\n\n</details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
