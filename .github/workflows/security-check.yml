name: Python Security Checks

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: read
      contents: read
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.3'

      - name: Set up cache for pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          cd portfolai
          pip install -r requirements.txt
          pip install safety bandit pylint flake8 PyGithub
      
      - name: Run Bandit (Static Code Analysis)
        id: bandit
        run: |
          cd portfolai
          echo "=== Bandit Security Scan ==="
          bandit -r core -f json -o bandit.json -c bandit.yaml -s MEDIUM || true
          echo ""
          echo "=== Bandit Summary ==="
          if [ -f bandit.json ]; then
            python -c "import json; data = json.load(open('bandit.json')); results = data.get('results', []); high = sum(1 for r in results if r.get('issue_severity') == 'HIGH'); med = sum(1 for r in results if r.get('issue_severity') == 'MEDIUM'); low = sum(1 for r in results if r.get('issue_severity') == 'LOW'); print(f'HIGH: {high}, MEDIUM: {med}, LOW: {low}, Total: {len(results)}')"
          fi
        continue-on-error: true
      
      - name: Run PyLint
        id: pylint
        run: |
          cd portfolai
          echo "=== PyLint Code Quality Check ==="
          python -m pylint core --output-format=text | tee pylint.txt || true
        continue-on-error: true
      
      - name: Run Flake8
        id: flake8
        run: |
          cd portfolai
          echo "=== Flake8 Style Check ==="
          flake8 core --format=default | tee flake8.txt || true
        continue-on-error: true
      
      - name: Run Safety (Dependency Check)
        id: safety
        run: |
          cd portfolai
          echo "=== Safety Dependency Vulnerability Check ==="
          safety check --json > safety.json 2>&1 || safety check | tee safety.txt 2>&1 || true
        continue-on-error: true
      
      - name: Post security report to PR
        if: github.event_name == 'pull_request'
        run: |
          cd portfolai
          python ../security_report.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_PR_ID: ${{ github.event.pull_request.number }}
      
      - name: Check for high severity issues
        run: |
          cd portfolai
          if [ -f bandit.json ]; then
            python -c "import json; data = json.load(open('bandit.json')); high_count = sum(1 for r in data.get('results', []) if r.get('issue_severity') == 'HIGH'); exit(1 if high_count > 0 else 0)"
          fi